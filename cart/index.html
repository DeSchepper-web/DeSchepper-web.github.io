<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex, nofollow">
  <title>Your Cart – Form Precision</title>
  <meta name="description" content="Review your selected Form Precision products and proceed to checkout. Premium carbon fiber nylon parts — engineered in the USA by ABET-accredited professionals." />
  <!-- Preload fonts for faster rendering -->
  <link rel="preload" href="/fonts/Satoshi-Regular.woff2" as="font" type="font/woff2" crossorigin>
  <link rel="preload" href="/fonts/RecklessNeue-Regular.woff2" as="font" type="font/woff2" crossorigin> 
  <link rel="stylesheet" href="/style.css" />
  <link rel="canonical" href="https://formprecision.com/cart/" />

  <!-- Favicons -->
  <link rel="icon" href="/images/favicon.svg" type="image/svg+xml">
  <link rel="icon" href="/images/favicon.ico" sizes="any">
  <link rel="icon" type="image/png" sizes="96x96" href="/images/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/images/favicon-192x192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/images/favicon-512x512.png">
  <link rel="apple-touch-icon" href="/images/apple-touch-icon.png">
  <link rel="manifest" href="/images/site.webmanifest">

  <!-- Open Graph / Twitter -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="Your Cart – Form Precision">
  <meta property="og:description" content="Review your selected Form Precision products and proceed to checkout. Premium carbon fiber nylon parts — engineered in the USA.">
  <meta property="og:url" content="https://formprecision.com/cart/">
  <meta property="og:image" content="https://formprecision.com/images/formprecision-3d.png">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta name="twitter:card" content="summary_large_image">

  <!-- Schema: Organization (sitewide) -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Organization",
    "@id": "https://formprecision.com/#org",
    "name": "Form Precision",
    "url": "https://formprecision.com/",
    "logo": "https://formprecision.com/images/favicon-512x512.png",
    "description": "Additive Manufacturing, 3D Printing, and custom parts by ABET-accredited engineers.",
    "contactPoint": [{
      "@type": "ContactPoint",
      "telephone": "+1-470-449-1983",
      "contactType": "Customer Support"
    }],
    "sameAs": [
      "https://www.instagram.com/formprecision/",
      "https://www.tiktok.com/@formprecision",
      "https://www.youtube.com/@FormPrecision"
    ]
  }
  </script>

  <!-- Schema: WebSite (sitewide) -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebSite",
    "name": "Form Precision",
    "url": "https://formprecision.com/"
  }
  </script>

  <!-- Schema: Breadcrumb (page-specific) -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    "itemListElement": [
      { "@type": "ListItem", "position": 1, "name": "Home", "item": "https://formprecision.com/" },
      { "@type": "ListItem", "position": 2, "name": "Cart", "item": "https://formprecision.com/cart/" }
    ]
  }
  </script>
</head>

<body>

<nav class="navbar" aria-label="Primary Navigation">
  <div class="navbar-left">
    <!-- Hamburger (mobile only) -->
    <button class="menu-toggle" type="button" aria-label="Open menu" aria-controls="primary-nav" aria-expanded="false">
      <span class="bar"></span>
      <span class="bar"></span>
      <span class="bar"></span>
    </button>

    <!-- Brand -->
    <a href="/" class="brand">FORM PRECISION</a>
  </div>

  <!-- Unified Nav Links -->
  <ul id="primary-nav" class="nav-links" data-behavior="offcanvas" aria-hidden="true">
    <li class="drawer-header" aria-hidden="true">
      <span>MENU</span>
      <button class="drawer-close" type="button" aria-label="Close menu">×</button>
    </li>
    <li><a href="/defense/">Defense</a></li>
    <li><a href="/automotive/">Automotive</a></li>
    <li><a href="/industrial/">Industrial</a></li>
    <li><a href="/articles/">Articles</a></li>
    <li><a href="/contact/">Contact</a></li>
  </ul>

  <div class="navbar-right">
    <a href="/cart/" class="cart-link">
      <svg class="cart-icon" viewBox="0 0 100 79" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
        <path d="M94.076 0C91.998 0 90.15 1.113 89.1 2.776H80.739C80.626 2.77 80.512 2.77 80.4 2.776C79.196 2.908 78.178 3.727 77.794 4.875L74.409 14.793H2.065H0L0.542 16.757L10.834 53.994L11.139 55.145H12.324H60.597L59.142 59.376H14.726C14.704 59.375 14.681 59.377 14.659 59.376C14.582 59.376 14.499 59.376 14.422 59.376C9.11 59.376 4.74 63.744 4.74 69.058C4.74 74.372 9.109 78.74 14.422 78.74C19.735 78.74 24.104 74.372 24.104 69.058C24.104 67.842 23.877 66.681 23.461 65.605H56.873C56.456 66.681 56.196 67.842 56.196 69.058C56.196 74.371 60.598 78.74 65.911 78.74C71.224 78.74 75.593 74.372 75.593 69.058C75.593 63.744 71.225 59.376 65.911 59.376C65.854 59.376 65.8 59.376 65.742 59.376L82.938 8.971H89.1C90.147 10.65 91.984 11.781 94.077 11.781C97.291 11.781 100.001 9.105 100.001 5.891C100 2.676 97.29 0 94.076 0Z" fill="currentColor"/>
      </svg>
      <span class="cart-label">Cart (<span id="cart-count">0</span>)</span>
    </a>
  </div>
</nav>

<!-- Overlay -->
<div class="overlay" id="overlay" aria-hidden="true"></div>

<!-- Cart Section -->
<section class="cart-section" data-cart>
  <h1>Your Cart</h1>

  <div id="cart-items" class="cart-items"></div>

  <p style="font-size:1.25rem;margin-top:1rem;">
    <strong>Total:</strong> $<span id="cart-total">0.00</span>
  </p>

<!-- replace your buttons wrapper line with this -->
<div style="margin-top:2rem;display:flex;flex-direction:column;gap:.75rem;align-items:center;">
  <button id="checkout-btn" data-proceed-checkout class="cta-button" type="button">
    Proceed to Checkout
  </button>
  <button id="clear-cart-btn" data-clear-cart class="cta-button" type="button">
    Clear Cart
  </button>
</div>

  <p id="cart-error" class="form-error" aria-live="polite" hidden
     style="margin-top:1rem;color:#B42318;"></p>
</section>

<script type="module">
  // TODO: replace with your Worker endpoint:
  // e.g. 'https://checkout.formprecision.workers.dev/create-checkout-session'
  const WORKER_ENDPOINT = 'https://formprecision.com/api/checkout';

  const $ = (sel) => document.querySelector(sel);
  const checkoutBtn = $('#checkout-btn');
  const clearBtn    = $('#clear-cart-btn');
  const itemsEl     = $('#cart-items');
  const totalEl     = $('#cart-total');
  const errEl       = $('#cart-error');

  const hasFn = (name) => typeof window[name] === 'function';

  // --- Read your existing cart (tries common patterns; adjust if you have a custom getter) ---
  function readCart(){
    if (hasFn('getCart')) return window.getCart();                           // preferred
    if (window.cart && Array.isArray(window.cart.items)) return window.cart; // global
    try {
      const raw = localStorage.getItem('fp-cart') || localStorage.getItem('cart');
      if (raw) return JSON.parse(raw);
    } catch {}
    return { items: [] };
  }

  // Build the variant lookup_key your Worker expects (must match Stripe Price lookup_key)
  function variantKeyFromItem(i){
    if (i.variantKey)  return String(i.variantKey);
    if (i.key)         return String(i.key);
    if (i.lookup_key)  return String(i.lookup_key);
    // If you store options, e.g. { sku:'rmr_mount', options:{ size:'30mm', color:'black'} }
    if (i.sku && i.options && typeof i.options === 'object'){
      const parts = [i.sku, ...Object.values(i.options)];
      return parts.join(':').toLowerCase(); // e.g. "rmr_mount:30mm:black"
    }
    if (i.sku) return String(i.sku); // last resort (not ideal)
    return null;
  }

  function buildStripePayload(){
    const cart = readCart();
    const missing = [];
    const items = (cart.items || []).map(i => {
      const key = variantKeyFromItem(i);
      const qty = Number(i.qty ?? i.quantity ?? 1);
      if (!key) missing.push(i);
      return { key, qty };
    }).filter(x => x.key && x.qty > 0);
    return { items, missing };
  }

  async function goCheckout(){
    errEl.hidden = true;
    const { items, missing } = buildStripePayload();

    if (missing.length){
      errEl.textContent = 'Some items are missing a variant key (lookup_key). Reselect options and try again.';
      errEl.hidden = false;
      return;
    }
    if (!items.length){
      errEl.textContent = 'Your cart is empty.';
      errEl.hidden = false;
      return;
    }

    const original = checkoutBtn.textContent;
    checkoutBtn.disabled = true;
    checkoutBtn.textContent = 'Redirecting…';

    try {
      const res  = await fetch(WORKER_ENDPOINT, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ items }) // [{ key:'rmr_mount:30mm:black', qty:1 }, ...]
      });
      const data = await res.json();
      if (data.url) {
        window.location = data.url; // Stripe Checkout
      } else {
        throw new Error(data.error || 'Unknown error');
      }
    } catch (e) {
      errEl.textContent = 'Checkout failed: ' + e.message;
      errEl.hidden = false;
      checkoutBtn.disabled = false;
      checkoutBtn.textContent = original;
    }
  }

  checkoutBtn?.addEventListener('click', goCheckout);

  clearBtn?.addEventListener('click', () => {
    if (hasFn('clearCart')) { window.clearCart(); } // your site’s clear method
    else {
      localStorage.removeItem('fp-cart');
      localStorage.removeItem('cart');
    }
    itemsEl && (itemsEl.innerHTML = '');
    totalEl && (totalEl.textContent = '0.00');
  });
</script>

<!-- Footer -->
<footer class="site-footer">
  <div class="social-icons">
    <a href="https://www.instagram.com/formprecision/" target="_blank" rel="noopener" aria-label="Instagram">
      <svg viewBox="0 0 24 24" fill="currentColor" class="social-icon" aria-hidden="true" focusable="false">
        <path d="M7.75 2h8.5A5.75 5.75 0 0 1 22 7.75v8.5A5.75 5.75 0 0 1 16.25 22h-8.5A5.75 5.75 0 0 1 2 16.25v-8.5A5.75 5.75 0 0 1 7.75 2zm0 1.5A4.25 4.25 0 0 0 3.5 7.75v8.5A4.25 4.25 0 0 0 7.75 20.5h8.5A4.25 4.25 0 0 0 20.5 16.25v-8.5A4.25 4.25 0 0 0 16.25 3.5h-8.5zm4.25 4a5 5 0 1 1 0 10 5 5 0 0 1 0-10zm0 1.5a3.5 3.5 0 1 0 0 7 3.5 3.5 0 0 0 0-7zm4.88-.88a.88.88 0 1 1-1.76 0 .88.88 0 0 1 1.76 0z"/>
      </svg>
    </a>
    <a href="https://www.tiktok.com/@formprecision" target="_blank" rel="noopener" aria-label="TikTok">
      <svg viewBox="0 0 24 24" fill="currentColor" class="social-icon" aria-hidden="true" focusable="false">
        <path d="M12.753 2h3.136c.183 1.486 1.315 2.72 2.807 2.942v3.136a6.004 6.004 0 0 1-3.519-1.115v7.533a5.753 5.753 0 1 1-5.753-5.753c.221 0 .438.015.653.043v3.184a2.575 2.575 0 1 0 1.676 2.44V2z"/>
      </svg>
    </a>
    <a href="https://www.youtube.com/@FormPrecision" target="_blank" rel="noopener" aria-label="YouTube">
      <svg viewBox="0 0 24 24" fill="currentColor" class="social-icon" aria-hidden="true" focusable="false">
        <path d="M21.8 8s-.2-1.4-.8-2c-.7-.8-1.4-.8-1.7-.9C16.4 5 12 5 12 5h0s-4.4 0-7.3.1c-.4 0-1 .1-1.7.9-.6.6-.8 2-.8 2S2 9.6 2 11.3v1.4c0 1.7.2 3.3.2 3.3s.2 1.4.8 2c.7.8 1.7.8 2.1.9 1.5.1 6.9.1 6.9.1s4.4 0 7.3-.1c.4 0 1-.1 1.7-.9.6-.6.8-2 .8-2s.2-1.7.2-3.3v-1.4c0-1.7-.2-3.3-.2-3.3zM9.8 14.6V9.4l5.2 2.6-5.2 2.6z"/>
      </svg>
    </a>
  </div>
  <p>© 2025 Form Precision — All Rights Reserved</p>
</footer>

<!-- Unified external script -->
<script src="/script.js" defer></script>
<script src="https://js.stripe.com/v3" defer></script>
</body>
</html>
